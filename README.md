# IATI Serverless Refresher

Serverless service based on the IATI Better Refresher

# Docker

# Local Docker setup

```
docker build .
```

# Local Docker testing

```
docker run --env-file=.env IMAGE_NAME
```

# Local Machine Set Up

## Prerequisities

- Python 3
- PostgreSQL (version 12)
  - psycopg2 does not work with v13

## Create Database

- Creates a database called `refresher` owned by `refresh`
  `createdb refresher -O refresh`

## Environment Variables

These are required:

### AZURE_STORAGE_CONNECTION_STRING

- This can be found in the Storage Account > Access Keys or by running `az storage account show-connection-string -g MyResourceGroup -n MyStorageAccount`

### AZURE_STORAGE_CONTAINER_SOURCE

- The string name of your blob container in Azure E.g. fun-blob-1

### DB_CONNECTION_STRING

- The connection string for your local postgresql database for the refresher
  - If you create the database like above then this is the string:
    - "postgresql://refresh:refresh@localhost/refresher"

# DB Migrations

Database migrations are handled using Alembic - https://alembic.sqlalchemy.org/

Refer to its fine documentation, and then when making migrations change the autogenerated revision name to reflect the version to which it relates, following the convention - ie for version 0.3.1, change it to BR_0_3_1_whatever_message.py
